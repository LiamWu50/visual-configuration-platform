var e=Object.defineProperty,t=(t,i,n)=>(((t,i,n)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n})(t,"symbol"!=typeof i?i+"":i,n),n);import{a7 as i,k as n,d as l,m as o,B as r,Q as s,z as a,s as u,v as c,O as d,y as p,a8 as h,H as v,a9 as m,A as f,h as y,E as g,P as b,aa as x,F as S}from"./index-7bb835e0.js";import{u as w}from"./index-11413298.js";import{l as P}from"./lodash-4461a34b.js";import{u as _}from"./use-message-6d894c6a.js";const C=i("areaSelect",(()=>{const e=n(null),t=n([]),i=n(!1);return{groupStyle:e,selectedPrimitives:t,areaSelectVisible:i,clearPrimitives:()=>{t.value=[]},setAreaSelectOptions:(i,n)=>{e.value=i,t.value=n},setAreaSelectVisible:e=>{i.value=e}}}));function E(e){return 100*e+"%"}const N=["fontSize","width","height","top","left","borderWidth","letterSpacing","borderRadius"];function D(e){return{top:e.top,left:e.left,right:e.left+e.width,bottom:e.top+e.height}}function O(e,t=[]){const i={};return Object.keys(e).forEach((n=>{t.includes(n)||e[n]&&(i[n]=e[n],N.includes(n)&&(i[n]+="px"))})),i}function j(e){const t={};for(const[i,n]of Object.entries(e))n&&(t[i]=`${n}px`);return t}function k(e,t,i){const n=document.getElementById(`primitive${e.id}`).getBoundingClientRect(),l=n.left-t.left+n.width/2,o=n.top-t.top+n.height/2;e.style.width=parseFloat(e.groupStyle.width)/100*i.width,e.style.height=parseFloat(e.groupStyle.height)/100*i.height,e.style.left=l-e.style.width/2,e.style.top=o-e.style.height/2,e.groupStyle={}}const M="_areaSelect_1vkaz_1",L=l({name:"AreaSelect",props:{options:{type:Object,default:()=>{}}},setup(e){const t=o((()=>({left:e.options.start.x+"px",top:e.options.start.y+"px",width:e.options.width+"px",height:e.options.height+"px"})));return()=>r("div",{style:t.value,class:M},null)}});const Y=new class{constructor(){t(this,"events",{})}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].includes(t)||this.events[e].push(t)}off(e,t){const i=this.events[e];i&&(this.events[e]=i.filter((e=>e!==t)))}emit(e,t){const i=this.events[e];if(i&&i.length>0)for(const n of i)n(t)}once(e,t){const i=n=>{t(n),this.off(e,i)};this.on(e,i)}},X="_markLine_18mj9_1",B="_line_18mj9_5",A="_xline_18mj9_11",R="_yline_18mj9_16",T=l({name:"AuxiliaryLine",setup(){const e=w(),t=n([]),i=["xt","xc","xb","yl","yc","yr"],l=n(3),o=s({xt:!1,xc:!1,xb:!1,yl:!1,yc:!1,yr:!1}),d=e=>{t.value.push(e)},p=()=>{Object.keys(o).forEach((e=>{o[e]=!1}))},h=(i,n)=>{const{primitives:l}=e,o=e.curPrimitive;if(!o)return;const{top:r,left:s,right:a,bottom:u}=D(o.style),c=(a-s)/2,d=(u-r)/2;p(),l.forEach((e=>{if(e==o)return;const l=D(e.style),{top:p,left:h,bottom:f,right:y}=l,g=(y-h)/2,b=(f-p)/2,x={top:[{isNearly:m(r,p),lineNode:t.value[0],line:"xt",dragShift:p,lineShift:p},{isNearly:m(u,p),lineNode:t.value[0],line:"xt",dragShift:p-(u-r||0),lineShift:p},{isNearly:m((r||0)+d,p+b),lineNode:t.value[1],line:"xc",dragShift:p+b-d,lineShift:p+b},{isNearly:m(r,f),lineNode:t.value[2],line:"xb",dragShift:f,lineShift:f},{isNearly:m(u,f),lineNode:t.value[2],line:"xb",dragShift:f-(u-r||0),lineShift:f}],left:[{isNearly:m(s,h),lineNode:t.value[3],line:"yl",dragShift:h,lineShift:h},{isNearly:m(a,h),lineNode:t.value[3],line:"yl",dragShift:h-(a-s||0),lineShift:h},{isNearly:m((s||0)+c,h+g),lineNode:t.value[4],line:"yc",dragShift:h+g-c,lineShift:h+g},{isNearly:m(s,y),lineNode:t.value[5],line:"yr",dragShift:y,lineShift:y},{isNearly:m(a,y),lineNode:t.value[5],line:"yr",dragShift:y-(a-s||0),lineShift:y}]},S=[];Object.keys(x).forEach((e=>{x[e].forEach((t=>{t.isNearly&&(o.updateStyleByKey(e,t.dragShift),t.lineNode.style[e]=`${t.lineShift}px`,S.push(t.line))}))})),v(S,i,n)}))},v=(e,t,i)=>{i?e.includes("yr")?o.yr=!0:e.includes("yc")?o.yc=!0:e.includes("yl")&&(o.yl=!0):e.includes("yl")?o.yl=!0:e.includes("yc")?o.yc=!0:e.includes("yr")&&(o.yr=!0),t?e.includes("xb")?o.xb=!0:e.includes("xc")?o.xc=!0:e.includes("xt")&&(o.xt=!0):e.includes("xt")?o.xt=!0:e.includes("xc")?o.xc=!0:e.includes("xb")&&(o.xb=!0)},m=(e,t)=>Math.abs(e-t)<=l.value;return a((()=>{Y.on("move",(({isDownward:e,isRightward:t})=>{h(e,t)})),Y.on("unmove",(()=>{p()})),h(!1,!1)})),()=>r("div",{class:X},[i.map((e=>u(r("div",{key:e,ref:d,class:`${B} ${e.includes("x")?A:R}`},null),[[c,o[e]]])))])}}),G="_boundBox_eobl6_1",$="_active_eobl6_8",I="_point_eobl6_14";const V=l({name:"BoundBox",props:{primitive:{type:Object,default:()=>{}},pStyle:{type:Object,default:()=>{}},index:{required:!0,type:Number,default:0}},emits:["closeContextmenu"],setup(e,{slots:t,emit:i}){const l=w(),s=C(),{curPrimitive:a}=d(l),{areaSelectVisible:u}=d(s),{curRef:c,cursors:h,angleToCursor:v,drawPoints:m}={curRef:n(null),cursors:n({}),angleToCursor:[{start:338,end:23,cursor:"nw"},{start:23,end:68,cursor:"n"},{start:68,end:113,cursor:"ne"},{start:113,end:158,cursor:"e"},{start:158,end:203,cursor:"se"},{start:203,end:248,cursor:"s"},{start:248,end:293,cursor:"sw"},{start:293,end:338,cursor:"w"}],drawPoints:{lt:0,t:45,rt:90,r:135,rb:180,b:225,lb:270,l:315}},f=t=>{const{width:i=0,height:n=0}=e.pStyle,l=t.includes("t"),o=t.includes("b"),r=t.includes("l"),s=t.includes("r");let a=r?0:i,u=l?0:n;return!l&&!o||r||s?l||o||!r&&!s||(a=r?0:i,u=Math.floor(n/2)):(a=i/2,u=l?0:n),{marginLeft:"-4px",marginTop:"-4px",left:`${a}px`,top:`${u}px`,cursor:h.value[t]}},y=()=>{const e={};let t=-1;for(const i in m){const n=(m[i]+360)%360;for(let l=0;l<v.length;l++){t=(t+1)%v.length;const l=v[t];if(n<23||n>=338){e[i]="nw-resize";break}if(l.start<=n&&n<l.end){e[i]=l.cursor+"-resize";break}}}return e},g=t=>{if(t.stopPropagation(),t.preventDefault(),u.value)return;l.setClickPrimitiveStatus(!0),l.setCurPrimitive(e.primitive),h.value=y();const i=e.pStyle,n=t.clientY,o=t.clientX,r=i.top||0,s=i.left||0,a=t=>{const i=t.clientX,l=t.clientY,a={top:P.ceil(t.clientY-n+r),left:P.ceil(t.clientX-o+s)};e.primitive.updateStyle(a);const u=l-n>0,c=i-o>0;Y.emit("move",{isDownward:u,isRightward:c})},c=()=>{Y.emit("unmove"),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",c)};p((()=>{a.value&&(h.value=y())}));const b=e=>{e.stopPropagation(),e.preventDefault(),i("closeContextmenu")},x=o((()=>{var t;return(null==(t=a.value)?void 0:t.id)===e.primitive.id})),S=()=>Object.keys(m).map((t=>r("div",{key:t,class:I,style:f(t),onMousedown:i=>((t,i)=>{i.stopPropagation(),i.preventDefault();const{pStyle:n}=e,{height:l=0,width:o=0,top:r=0,left:s=0}=n,a=i.clientX,u=i.clientY,c=e=>{const i=e.clientX,c=e.clientY-u,d=i-a,p=/t/.test(t),h=/b/.test(t),v=/l/.test(t),m=/r/.test(t),f=l+(p?-c:h?c:0),y=o+(v?-d:m?d:0);Object.assign(n,{height:Math.max(f,0),width:Math.max(y,0),left:s+(v?d:0),top:r+(p?c:0)})},d=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",d)})(t,i)},null)));return()=>{var e;return r("div",{ref:c,class:[G,x.value&&$],onClick:b,onMousedown:g},[x.value?S():null,null==(e=t.default)?void 0:e.call(t)])}}});function U(){const e=w(),t=C(),{curPrimitive:i}=d(e),{groupStyle:n,selectedPrimitives:l}=d(t);return{handleCompose:()=>{const i=[],o=l.value,r=document.querySelector("#editor").getBoundingClientRect();o.forEach((e=>{var t;if("Group"===e.cName){const n={...e.style};null==(t=e.childPrimitives)||t.forEach((e=>{k(e,r,n),i.push(e)}))}else i.push(e)}));const s=new h;s.childPrimitives=i,s.style={...n.value},function(e){var t;const i=e.style;null==(t=e.childPrimitives)||t.forEach((e=>{if(!Object.keys(e.groupStyle).length){const t={...e.style};e.groupStyle=O(t),e.groupStyle.left=E((t.left-i.left)/i.width),e.groupStyle.top=E((t.top-i.top)/i.height),e.groupStyle.width=E(t.width/i.width),e.groupStyle.height=E(t.height/i.height)}}))}(s);const a=l.value;e.batchDeletePrimitive(a),e.addPrimitive(s),e.setCurPrimitive(s),t.setAreaSelectVisible(!1),t.clearPrimitives()},handleDecompose:()=>{var t,n;const l={...null==(t=i.value)?void 0:t.style},o=null==(n=i.value)?void 0:n.childPrimitives,r=document.querySelector("#editor"),s=null==r?void 0:r.getBoundingClientRect();e.deleteCurPrimitive(),o.forEach((t=>{k(t,s,l),e.addPrimitive(t)}))}}}const q="_contextmenu_1ltzl_1",z=l({name:"ContextMenu",setup(e,{expose:t}){const i=_(),l=w(),o=C(),{handleCompose:a,handleDecompose:p}=U(),{curPrimitive:h}=d(l),{areaSelectVisible:f}=d(o),y=s({visible:n(!1),top:n(0),left:n(0),contextType:n(""),copyData:n(null),contextOptions:n([])}),g=()=>{l.setClickPrimitiveStatus(!0)},b=()=>{if(!y.copyData)return void i.warning("请选择组件！");const e=y.copyData;e.style.top=y.top,e.style.left=y.left,l.addPrimitive(e)},x=()=>{p()},S=[{label:"复制",handler:()=>{const e=P.cloneDeep(h.value);e.id=m.createId(),y.copyData=e,i.success("复制成功！")}},{label:"粘贴",handler:b},{label:"删除",handler:()=>{l.deleteCurPrimitive(),i.success("删除成功！")}},{label:"置顶",handler:()=>{l.upCurComponent()}},{label:"置底",handler:()=>{l.downCurComponent()}},{label:"上移",handler:()=>{l.moveCurPrimitiveByIndex(1)}},{label:"下移",handler:()=>{l.moveCurPrimitiveByIndex(-1)}}],E=[{label:"组合",handler:()=>{a()}},{label:"删除",handler:x}],N=[{label:"粘贴",handler:b},{label:"清空画布",handler:()=>{l.clear()}}],D=()=>{f.value?y.contextOptions=[...E]:"Editor"===y.contextType?y.contextOptions=[...N]:(y.contextOptions=[...S],"Group"===y.contextType&&y.contextOptions.unshift({label:"解除分组",handler:x}))};return t({show:({top:e,left:t,contextType:i})=>{y.top=e,y.left=t,y.contextType=i,D(),y.visible=!0},close:()=>{y.visible=!1}}),()=>u(r("div",{class:q,style:{top:`${y.top}px`,left:`${y.left}px`}},[r("ul",{onMouseup:g,onMousedown:e=>e.stopPropagation()},[y.contextOptions.map((e=>r("li",{onClick:e.handler},[e.label,v(" "),e.disabled])))])]),[[c,y.visible]])}}),F=l({name:"Grid",render:()=>r("svg",{style:{position:"absolute",top:0,left:0},width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg"},[r("defs",null,[r("pattern",{id:"smallGrid",width:"7.236328125",height:"7.236328125",patternUnits:"userSpaceOnUse"},[r("path",{d:"M 7.236328125 0 L 0 0 0 7.236328125",fill:"none",stroke:"rgba(207, 207, 207, 0.3)","stroke-width":"1"},null)]),r("pattern",{id:"grid",width:"36.181640625",height:"36.181640625",patternUnits:"userSpaceOnUse"},[r("rect",{width:"36.181640625",height:"36.181640625",fill:"url(#smallGrid)"},null),r("path",{d:"M 36.181640625 0 L 0 0 0 36.181640625",fill:"none",stroke:"rgba(186, 186, 186, 0.5)","stroke-width":"1"},null)])]),r("rect",{width:"100%",height:"100%",fill:"url(#grid)"},null)])});const H="_editor_3q8bl_1",K="_primitive_3q8bl_8";const Q=l({name:"Editor",components:{Grid:F,AreaSelect:L,ContextMenu:z},setup(){const e=w(),t=C(),{areaSelectVisible:i}=d(t),{groupState:l,onDrawGroupBoundry:o}=function(){const e=w(),t=C(),{primitives:i}=d(e),n=s({editorX:0,editorY:0,start:{x:0,y:0},width:0,height:0}),l=()=>{n.width=0,n.height=0,t.setAreaSelectVisible(!1),t.setAreaSelectOptions(null,[])},o=()=>{const e=r();if(e.length<=1)return void l();let i=1/0,o=1/0,s=-1/0,a=-1/0;e.forEach((e=>{var t;let l={};"Group"===e.cName?null==(t=e.childPrimitives)||t.forEach((e=>{const t=document.getElementById(`primitive${e.id}`).getBoundingClientRect();l.left=t.left-n.editorX,l.top=t.top-n.editorY,l.right=t.right-n.editorX,l.bottom=t.bottom-n.editorY,l.left<o&&(o=l.left),l.top<i&&(i=l.top),l.right>s&&(s=l.right),l.bottom>a&&(a=l.bottom)})):l=function(e){const t=e.top+e.height,i=e.left+e.width;return{left:e.left,top:e.top,right:i,bottom:t}}(e.style),l.left<o&&(o=l.left),l.top<i&&(i=l.top),l.right>s&&(s=l.right),l.bottom>a&&(a=l.bottom)})),n.start.x=o,n.start.y=i,n.width=s-o,n.height=a-i;const u={left:o,top:i,width:n.width,height:n.height};t.setAreaSelectOptions(u,e)},r=()=>{const{x:e,y:t}=n.start;return i.value.filter((i=>{const{left:l,top:o,width:r,height:s}=i.style;if(e<=l&&t<=o&&l+r<=e+n.width&&o+s<=t+n.height)return i}))};return{groupState:n,onDrawGroupBoundry:e=>{l();const i=document.getElementById("editor").getBoundingClientRect();n.editorX=i.x,n.editorY=i.y;const r=e.clientX,s=e.clientY;n.start.x=r-n.editorX,n.start.y=s-n.editorY,t.setAreaSelectVisible(!0);const a=e=>{n.width=Math.abs(e.clientX-r),n.height=Math.abs(e.clientY-s),e.clientX<r&&(n.start.x=e.clientX-n.editorX),e.clientY<s&&(n.start.y=e.clientY-n.editorY)},u=e=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u),e.clientX!=r||e.clientY!=s?o():l()};document.addEventListener("mousemove",a),document.addEventListener("mouseup",u)}}}(),{curPrimitive:a,primitives:p}=d(e),h=n(null),v=n(null);f("AUXILIARY_LINE_KEY",v);const m=["width","height","top","left"],x=t=>{0===t.button&&(e.setClickPrimitiveStatus(!1),a||t.preventDefault(),o(t))},S=t=>{var i;e.isClickPrimitive||e.setCurPrimitive(null),2!==t.button&&(null==(i=h.value)||i.close())},P=e=>{if(!e||!e.parentNode)return;const t=e.parentNode;if(!t.getAttribute)return;const i=t.getAttribute("data-context");return i||P(t)},_=e=>{var t;if(e.stopPropagation(),e.preventDefault(),!e.target)return;let i=e.target,n=e.offsetY,l=e.offsetX;for(;i instanceof SVGElement;)i=i.parentNode;for(;"editor"!==i.id;)l+=i.offsetLeft,n+=i.offsetTop,i=i.parentNode;const o=P(e.target);null==(t=h.value)||t.show({top:n,left:l,contextType:o})},E=()=>{var e;null==(e=h.value)||e.close()},N=()=>p.value.map(((e,t)=>{let i;return r(V,{index:t,style:j(e.style),primitive:e,pStyle:e.style,onCloseContextmenu:E},"function"==typeof(n=i=y(g(e.cName),{id:`primitive${e.id}`,class:K,style:(l=e.style,O(l,m)),"data-context":e.cName,dataSource:e}))||"[object Object]"===Object.prototype.toString.call(n)&&!b(n)?i:{default:()=>[i]});var n,l}));return()=>r("div",{id:"editor","data-context":"Editor",class:H,onMousedown:x,onMouseup:S,onContextmenu:_},[r(F,null,null),u(r(L,{options:l},null),[[c,i.value]]),r(T,null,null),r(z,{ref:h},null),N()])}}),W="_container_79xjy_1",J=l({name:"Container",components:{Editor:Q},setup(){const{...e}=(()=>{const e=w();return{handleDrop:t=>{t.preventDefault(),t.stopPropagation();const i=t.dataTransfer.getData("name"),n=document.querySelector("#editor").getBoundingClientRect(),l=new x[i],o={top:P.ceil(t.clientY-n.y),left:P.ceil(t.clientX-n.x)};l.updateStyle(o),e.addPrimitive(l)},handleDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},handleMouseDown:e=>{e.stopPropagation()},handleMouseUp:()=>{}}})();return{...e}},render(){return r(S,null,[r("div",{class:W,onDrop:this.handleDrop,onDragover:this.handleDragOver,onMousedown:this.handleMouseDown,onMouseup:this.handleMouseUp},[r(Q,null,null)])])}});export{J as default};
//# sourceMappingURL=index-2cdcf9dd.js.map
