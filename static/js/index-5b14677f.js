var e=Object.defineProperty,t=(t,i,n)=>(((t,i,n)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n})(t,"symbol"!=typeof i?i+"":i,n),n);import{ae as i,k as n,d as o,m as l,B as r,Z as s,z as a,s as u,v as c,I as d,y as p,af as h,H as v,M as m,A as f,h as y,E as g,J as x,ag as b,F as S}from"./index-fe0af359.js";import{u as w}from"./index-b19b26c5.js";import{l as P}from"./lodash-b76f7637.js";import{u as _}from"./use-message-0e00b435.js";const C=i("areaSelect",(()=>{const e=n(null),t=n([]),i=n(!1);return{groupStyle:e,childPrimitives:t,areaSelectVisible:i,clearPrimitives:()=>{t.value=[]},setAreaSelectOptions:(i,n)=>{e.value=i,t.value=n},setAreaSelectVisible:e=>{i.value=e}}})),E="_areaSelect_1vkaz_1",N=o({name:"AreaSelect",props:{options:{type:Object,default:()=>{}}},setup(e){const t=l((()=>({left:e.options.start.x+"px",top:e.options.start.y+"px",width:e.options.width+"px",height:e.options.height+"px"})));return()=>r("div",{style:t.value,class:E},null)}});const D=new class{constructor(){t(this,"events",{})}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].includes(t)||this.events[e].push(t)}off(e,t){const i=this.events[e];i&&(this.events[e]=i.filter((e=>e!==t)))}emit(e,t){const i=this.events[e];if(i&&i.length>0)for(const n of i)n(t)}once(e,t){const i=n=>{t(n),this.off(e,i)};this.on(e,i)}};function O(e){return 100*e+"%"}const j=["fontSize","width","height","top","left","borderWidth","letterSpacing","borderRadius"];function M(e){return{top:e.top,left:e.left,right:e.left+e.width,bottom:e.top+e.height}}function B(e){return(e={...e}).bottom=e.top+e.height,e.right=e.left+e.width,e}function k(e,t,i){const n=document.getElementById(`primitive${e.id}`).getBoundingClientRect(),o=n.left-t.left+n.width/2,l=n.top-t.top+n.height/2;e.style.width=parseFloat(e.groupStyle.width)/100*i.width,e.style.height=parseFloat(e.groupStyle.height)/100*i.height,e.style.left=o-e.style.width/2,e.style.top=l-e.style.height/2,e.groupStyle={}}function L(e){var t;const i=e.style;null==(t=e.childPrimitives)||t.forEach((e=>{if(!e.groupStyle){const t={...e.style};e.groupStyle=function(e,t=[]){const i={};return Object.keys(e).forEach((n=>{t.find((e=>n===e))||e[n]&&(i[n]=e[n],j.includes(n)&&(i[n]+="px"))})),i}(t),e.groupStyle.left=O((t.left-i.left)/i.width),e.groupStyle.top=O((t.top-i.top)/i.height),e.groupStyle.width=O(t.width/i.width),e.groupStyle.height=O(t.height/i.height)}}))}const Y="_markLine_18mj9_1",X="_line_18mj9_5",A="_xline_18mj9_11",R="_yline_18mj9_16",T=o({name:"AuxiliaryLine",setup(){const e=w(),t=n([]),i=["xt","xc","xb","yl","yc","yr"],o=n(3),l=s({xt:!1,xc:!1,xb:!1,yl:!1,yc:!1,yr:!1}),d=e=>{t.value.push(e)},p=()=>{Object.keys(l).forEach((e=>{l[e]=!1}))},h=(i,n)=>{const{primitives:o}=e,l=e.curPrimitive;if(!l)return;const{top:r,left:s,right:a,bottom:u}=M(l.style),c=(a-s)/2,d=(u-r)/2;p(),o.forEach((e=>{if(e==l)return;const o=M(e.style),{top:p,left:h,bottom:f,right:y}=o,g=(y-h)/2,x=(f-p)/2,b={top:[{isNearly:m(r,p),lineNode:t.value[0],line:"xt",dragShift:p,lineShift:p},{isNearly:m(u,p),lineNode:t.value[0],line:"xt",dragShift:p-(u-r||0),lineShift:p},{isNearly:m((r||0)+d,p+x),lineNode:t.value[1],line:"xc",dragShift:p+x-d,lineShift:p+x},{isNearly:m(r,f),lineNode:t.value[2],line:"xb",dragShift:f,lineShift:f},{isNearly:m(u,f),lineNode:t.value[2],line:"xb",dragShift:f-(u-r||0),lineShift:f}],left:[{isNearly:m(s,h),lineNode:t.value[3],line:"yl",dragShift:h,lineShift:h},{isNearly:m(a,h),lineNode:t.value[3],line:"yl",dragShift:h-(a-s||0),lineShift:h},{isNearly:m((s||0)+c,h+g),lineNode:t.value[4],line:"yc",dragShift:h+g-c,lineShift:h+g},{isNearly:m(s,y),lineNode:t.value[5],line:"yr",dragShift:y,lineShift:y},{isNearly:m(a,y),lineNode:t.value[5],line:"yr",dragShift:y-(a-s||0),lineShift:y}]},S=[];Object.keys(b).forEach((e=>{b[e].forEach((t=>{t.isNearly&&(l.updateStyleByKey(e,t.dragShift),t.lineNode.style[e]=`${t.lineShift}px`,S.push(t.line))}))})),v(S,i,n)}))},v=(e,t,i)=>{i?e.includes("yr")?l.yr=!0:e.includes("yc")?l.yc=!0:e.includes("yl")&&(l.yl=!0):e.includes("yl")?l.yl=!0:e.includes("yc")?l.yc=!0:e.includes("yr")&&(l.yr=!0),t?e.includes("xb")?l.xb=!0:e.includes("xc")?l.xc=!0:e.includes("xt")&&(l.xt=!0):e.includes("xt")?l.xt=!0:e.includes("xc")?l.xc=!0:e.includes("xb")&&(l.xb=!0)},m=(e,t)=>Math.abs(e-t)<=o.value;return a((()=>{D.on("move",(({isDownward:e,isRightward:t})=>{h(e,t)})),D.on("unmove",(()=>{p()})),h(!1,!1)})),()=>r("div",{class:Y},[i.map((e=>u(r("div",{key:e,ref:d,class:`${X} ${e.includes("x")?A:R}`},null),[[c,l[e]]])))])}}),G="_boundBox_1iwyd_1",I="_active_1iwyd_8",$="_point_1iwyd_15";const V=o({name:"BoundBox",props:{primitive:{type:Object,default:()=>{}},pStyle:{type:Object,default:()=>{}},index:{required:!0,type:Number,default:0}},emits:["closeContextmenu"],setup(e,{slots:t,emit:i}){const o=w(),s=C(),{curPrimitive:a}=d(o),{areaSelectVisible:u}=d(s),{curRef:c,cursors:h,angleToCursor:v,drawPoints:m}={curRef:n(null),cursors:n({}),angleToCursor:[{start:338,end:23,cursor:"nw"},{start:23,end:68,cursor:"n"},{start:68,end:113,cursor:"ne"},{start:113,end:158,cursor:"e"},{start:158,end:203,cursor:"se"},{start:203,end:248,cursor:"s"},{start:248,end:293,cursor:"sw"},{start:293,end:338,cursor:"w"}],drawPoints:{lt:0,t:45,rt:90,r:135,rb:180,b:225,lb:270,l:315}},f=t=>{const{width:i=0,height:n=0}=e.pStyle,o=t.includes("t"),l=t.includes("b"),r=t.includes("l"),s=t.includes("r");let a=r?0:i,u=o?0:n;return!o&&!l||r||s?o||l||!r&&!s||(a=r?0:i,u=Math.floor(n/2)):(a=i/2,u=o?0:n),{marginLeft:"-4px",marginTop:"-4px",left:`${a}px`,top:`${u}px`,cursor:h.value[t]}},y=()=>{const e={};let t=-1;for(const i in m){const n=(m[i]+360)%360;for(let o=0;o<v.length;o++){t=(t+1)%v.length;const o=v[t];if(n<23||n>=338){e[i]="nw-resize";break}if(o.start<=n&&n<o.end){e[i]=o.cursor+"-resize";break}}}return e},g=t=>{if(t.stopPropagation(),t.preventDefault(),u.value)return;o.setClickPrimitiveStatus(!0),o.setCurPrimitive(e.primitive),h.value=y();const i=e.pStyle,n=t.clientY,l=t.clientX,r=i.top||0,s=i.left||0,a=t=>{const i=t.clientX,o=t.clientY,a={top:P.ceil(t.clientY-n+r),left:P.ceil(t.clientX-l+s)};e.primitive.updateStyle(a);const u=o-n>0,c=i-l>0;D.emit("move",{isDownward:u,isRightward:c})},c=()=>{D.emit("unmove"),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",c)};p((()=>{a.value&&(h.value=y())}));const x=e=>{e.stopPropagation(),e.preventDefault(),i("closeContextmenu")},b=l((()=>{var t;return(null==(t=a.value)?void 0:t.id)===e.primitive.id})),S=()=>Object.keys(m).map((t=>r("div",{key:t,class:$,style:f(t),onMousedown:i=>((t,i)=>{i.stopPropagation(),i.preventDefault();const{pStyle:n}=e,{height:o=0,width:l=0,top:r=0,left:s=0}=n,a=i.clientX,u=i.clientY,c=e=>{const i=e.clientX,c=e.clientY-u,d=i-a,p=/t/.test(t),h=/b/.test(t),v=/l/.test(t),m=/r/.test(t),f=o+(p?-c:h?c:0),y=l+(v?-d:m?d:0);Object.assign(n,{height:Math.max(f,0),width:Math.max(y,0),left:s+(v?d:0),top:r+(p?c:0)})},d=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",d)})(t,i)},null)));return()=>{var e;return r("div",{ref:c,class:[G,b.value&&I],onClick:x,onMousedown:g},[b.value?S():null,null==(e=t.default)?void 0:e.call(t)])}}});const U="_contextmenu_1ltzl_1",z=o({name:"ContextMenu",setup(e,{expose:t}){const i=_(),o=w(),l=C(),{handleCompose:a}=function(){const e=w(),t=C(),{curPrimitive:i}=d(e),{groupStyle:n,childPrimitives:o}=d(t);return{handleCompose:()=>{const i=[];o.value.forEach((e=>{var t;if("Group"===e.cName){const n={...e.style},o=document.querySelector("#editor").getBoundingClientRect();null==(t=e.childPrimitives)||t.forEach((e=>{k(e,o,n),i.push(e)}))}else i.push(e)}));const l=new h;l.childPrimitives=i,l.style={...n.value},L(l);const r=o.value;e.batchDeletePrimitive(r),e.addPrimitive(l),e.setCurPrimitive(l),t.setAreaSelectVisible(!1),t.clearPrimitives()},handleDecompose:()=>{var t,n;const o={...null==(t=i.value)?void 0:t.style},l=null==(n=i.value)?void 0:n.childPrimitives,r=document.querySelector("#editor"),s=null==r?void 0:r.getBoundingClientRect();e.deleteCurPrimitive(),l.forEach((t=>{k(t,s,o),e.addPrimitive(t)}))}}}(),{curPrimitive:p}=d(o),{areaSelectVisible:f}=d(l),y=s({visible:n(!1),top:n(0),left:n(0),contextType:n(""),copyData:n(null),contextOptions:n([])}),g=()=>{o.setClickPrimitiveStatus(!0)},x=()=>{if(!y.copyData)return void i.warning("请选择组件！");const e=y.copyData;e.style.top=y.top,e.style.left=y.left,o.addPrimitive(e)},b=()=>{a()},S=[{label:"复制",handler:()=>{const e=P.cloneDeep(p.value);e.id=m.createId(),y.copyData=e,i.success("复制成功！")}},{label:"粘贴",handler:x},{label:"删除",handler:()=>{o.deleteCurPrimitive(),i.success("删除成功！")}},{label:"置顶",handler:()=>{o.upCurComponent()}},{label:"置底",handler:()=>{o.downCurComponent()}},{label:"上移",handler:()=>{o.moveCurPrimitiveByIndex(1)}},{label:"下移",handler:()=>{o.moveCurPrimitiveByIndex(-1)}}],E=[{label:"组合",handler:()=>{a()}},{label:"删除",handler:b}],N=[{label:"粘贴",handler:x},{label:"清空画布",handler:()=>{o.clear()}}],D=()=>{f.value?y.contextOptions=[...E]:"Editor"===y.contextType?y.contextOptions=[...N]:(y.contextOptions=[...S],"Group"===y.contextType&&y.contextOptions.unshift({label:"解除分组",handler:b}))};return t({show:({top:e,left:t,contextType:i})=>{y.top=e,y.left=t,y.contextType=i,D(),y.visible=!0},close:()=>{y.visible=!1}}),()=>u(r("div",{class:U,style:{top:`${y.top}px`,left:`${y.left}px`}},[r("ul",{onMouseup:g,onMousedown:e=>e.stopPropagation()},[y.contextOptions.map((e=>r("li",{onClick:e.handler},[e.label,v(" "),e.disabled])))])]),[[c,y.visible]])}}),q=o({name:"Grid",render:()=>r("svg",{style:{position:"absolute",top:0,left:0},width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg"},[r("defs",null,[r("pattern",{id:"smallGrid",width:"7.236328125",height:"7.236328125",patternUnits:"userSpaceOnUse"},[r("path",{d:"M 7.236328125 0 L 0 0 0 7.236328125",fill:"none",stroke:"rgba(207, 207, 207, 0.3)","stroke-width":"1"},null)]),r("pattern",{id:"grid",width:"36.181640625",height:"36.181640625",patternUnits:"userSpaceOnUse"},[r("rect",{width:"36.181640625",height:"36.181640625",fill:"url(#smallGrid)"},null),r("path",{d:"M 36.181640625 0 L 0 0 0 36.181640625",fill:"none",stroke:"rgba(186, 186, 186, 0.5)","stroke-width":"1"},null)])]),r("rect",{width:"100%",height:"100%",fill:"url(#grid)"},null)])});const F="_editor_1iuos_1",K="_primitive_1iuos_8";const H=o({name:"Editor",components:{Grid:q,AreaSelect:N,ContextMenu:z},setup(){const e=w(),t=C(),{areaSelectVisible:i}=d(t),{groupState:o,onDrawGroupBoundry:l}=function(){const e=w(),t=C(),{primitives:i}=d(e),n=s({editorX:0,editorY:0,start:{x:0,y:0},width:0,height:0}),o=()=>{n.width=0,n.height=0,t.setAreaSelectVisible(!1),t.setAreaSelectOptions(null,[])},l=()=>{const e=r();if(e.length<=1)return void o();let i=1/0,l=1/0,s=-1/0,a=-1/0;e.forEach((e=>{var t;let o={};"Group"===e.cName?null==(t=e.childPrimitives)||t.forEach((e=>{const t=document.getElementById(`primitive${e.id}`).getBoundingClientRect();o.left=t.left-n.editorX,o.top=t.top-n.editorY,o.right=t.right-n.editorX,o.bottom=t.bottom-n.editorY,o.left<l&&(l=o.left),o.top<i&&(i=o.top),o.right>s&&(s=o.right),o.bottom>a&&(a=o.bottom)})):o=B(e.style),o.left<l&&(l=o.left),o.top<i&&(i=o.top),o.right>s&&(s=o.right),o.bottom>a&&(a=o.bottom)})),n.start.x=l,n.start.y=i,n.width=s-l,n.height=a-i;const u={left:l,top:i,width:n.width,height:n.height};t.setAreaSelectOptions(u,e)},r=()=>{const{x:e,y:t}=n.start;return i.value.filter((i=>{const{left:o,top:l,width:r,height:s}=B(i.style);if(e<=o&&t<=l&&o+r<=e+n.width&&l+s<=t+n.height)return i}))};return{groupState:n,onDrawGroupBoundry:e=>{o();const i=document.getElementById("editor").getBoundingClientRect();n.editorX=i.x,n.editorY=i.y;const r=e.clientX,s=e.clientY;n.start.x=r-n.editorX,n.start.y=s-n.editorY,t.setAreaSelectVisible(!0);const a=e=>{n.width=Math.abs(e.clientX-r),n.height=Math.abs(e.clientY-s),e.clientX<r&&(n.start.x=e.clientX-n.editorX),e.clientY<s&&(n.start.y=e.clientY-n.editorY)},u=e=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u),e.clientX!=r||e.clientY!=s?l():o()};document.addEventListener("mousemove",a),document.addEventListener("mouseup",u)}}}(),a=e.primitives,{curPrimitive:p}=d(e),h=n(null),v=n(null);f("AUXILIARY_LINE_KEY",v);const m=t=>{0===t.button&&(e.setClickPrimitiveStatus(!1),p||t.preventDefault(),l(t))},b=t=>{var i;e.isClickPrimitive||e.setCurPrimitive(null),2!==t.button&&(null==(i=h.value)||i.close())},S=e=>{if(!e||!e.parentNode)return;const t=e.parentNode;if(!t.getAttribute)return;const i=t.getAttribute("data-context");return i||S(t)},P=e=>{var t;if(e.stopPropagation(),e.preventDefault(),!e.target)return;let i=e.target,n=e.offsetY,o=e.offsetX;for(;i instanceof SVGElement;)i=i.parentNode;for(;"editor"!==i.id;)o+=i.offsetLeft,n+=i.offsetTop,i=i.parentNode;const l=S(e.target);null==(t=h.value)||t.show({top:n,left:o,contextType:l})},_=()=>{var e;null==(e=h.value)||e.close()},{getBoundBoxStyle:E}={getBoundBoxStyle:e=>{const t={};for(const[i,n]of Object.entries(e))n&&(t[i]=n+"px");return t},getPrimitiveStyle:e=>{const t={};for(const[i,n]of Object.entries(e))n&&(t[i]=n+"px");return t}},D=()=>a.map(((e,t)=>{let i;return r(V,{index:t,style:E(e.style),primitive:e,pStyle:e.style,onCloseContextmenu:_},"function"==typeof(n=i=y(g(e.cName),{id:`primitive${e.id}`,class:K,"data-context":e.cName,dataSource:e}))||"[object Object]"===Object.prototype.toString.call(n)&&!x(n)?i:{default:()=>[i]});var n}));return()=>r("div",{id:"editor","data-context":"Editor",class:F,onMousedown:m,onMouseup:b,onContextmenu:P},[r(q,null,null),u(r(N,{options:o},null),[[c,i.value]]),r(T,null,null),r(z,{ref:h},null),D()])}}),J="_container_79xjy_1",W=o({name:"Container",components:{Editor:H},setup(){const{...e}=(()=>{const e=w();return{handleDrop:t=>{t.preventDefault(),t.stopPropagation();const i=t.dataTransfer.getData("name"),n=document.querySelector("#editor").getBoundingClientRect(),o=new b[i],l={top:P.ceil(t.clientY-n.y),left:P.ceil(t.clientX-n.x)};o.updateStyle(l),e.addPrimitive(o)},handleDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},handleMouseDown:e=>{e.stopPropagation()},handleMouseUp:()=>{}}})();return{...e}},render(){return r(S,null,[r("div",{class:J,onDrop:this.handleDrop,onDragover:this.handleDragOver,onMousedown:this.handleMouseDown,onMouseup:this.handleMouseUp},[r(H,null,null)])])}});export{W as default};
//# sourceMappingURL=index-5b14677f.js.map
