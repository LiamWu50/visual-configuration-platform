var e=Object.defineProperty,t=(t,i,n)=>(((t,i,n)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n})(t,"symbol"!=typeof i?i+"":i,n),n);import{ae as i,k as n,d as o,m as r,B as l,Y as s,z as a,s as u,v as c,H as d,y as p,K as h,A as v,h as m,ad as f,I as y,af as g,F as x}from"./index-2489ea70.js";import{u as b}from"./index-dc8bef93.js";import{l as S}from"./lodash-8a048378.js";import{u as w}from"./use-message-155b3e70.js";const _=i("areaSelect",(()=>{const e=n(null),t=n([]),i=n(!1);return{groupStyle:e,childPrimitives:t,areaSelectVisible:i,setAreaSelectOptions:(i,n)=>{e.value=i,t.value=n},setAreaSelectVisible:e=>{i.value=e}}})),C="_areaSelect_1vkaz_1",N=o({name:"AreaSelect",props:{options:{type:Object,default:()=>{}}},setup(e){const t=r((()=>({left:e.options.start.x+"px",top:e.options.start.y+"px",width:e.options.width+"px",height:e.options.height+"px"})));return()=>l("div",{style:t.value,class:C},null)}});const P=new class{constructor(){t(this,"events",{})}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].includes(t)||this.events[e].push(t)}off(e,t){const i=this.events[e];i&&(this.events[e]=i.filter((e=>e!==t)))}emit(e,t){const i=this.events[e];if(i&&i.length>0)for(const n of i)n(t)}once(e,t){const i=n=>{t(n),this.off(e,i)};this.on(e,i)}};function E(e){return{top:e.top,left:e.left,right:e.left+e.width,bottom:e.top+e.height}}function D(e){return(e={...e}).bottom=e.top+e.height,e.right=e.left+e.width,e}const j="_markLine_18mj9_1",M="_line_18mj9_5",O="_xline_18mj9_11",Y="_yline_18mj9_16",k=o({name:"AuxiliaryLine",setup(){const e=b(),t=n([]),i=["xt","xc","xb","yl","yc","yr"],o=n(3),r=s({xt:!1,xc:!1,xb:!1,yl:!1,yc:!1,yr:!1}),d=e=>{t.value.push(e)},p=()=>{Object.keys(r).forEach((e=>{r[e]=!1}))},h=(i,n)=>{const{primitives:o}=e,r=e.curPrimitive;if(!r)return;const{top:l,left:s,right:a,bottom:u}=E(r.style),c=(a-s)/2,d=(u-l)/2;p(),o.forEach((e=>{if(e==r)return;const o=E(e.style),{top:p,left:h,bottom:f,right:y}=o,g=(y-h)/2,x=(f-p)/2,b={top:[{isNearly:m(l,p),lineNode:t.value[0],line:"xt",dragShift:p,lineShift:p},{isNearly:m(u,p),lineNode:t.value[0],line:"xt",dragShift:p-(u-l||0),lineShift:p},{isNearly:m((l||0)+d,p+x),lineNode:t.value[1],line:"xc",dragShift:p+x-d,lineShift:p+x},{isNearly:m(l,f),lineNode:t.value[2],line:"xb",dragShift:f,lineShift:f},{isNearly:m(u,f),lineNode:t.value[2],line:"xb",dragShift:f-(u-l||0),lineShift:f}],left:[{isNearly:m(s,h),lineNode:t.value[3],line:"yl",dragShift:h,lineShift:h},{isNearly:m(a,h),lineNode:t.value[3],line:"yl",dragShift:h-(a-s||0),lineShift:h},{isNearly:m((s||0)+c,h+g),lineNode:t.value[4],line:"yc",dragShift:h+g-c,lineShift:h+g},{isNearly:m(s,y),lineNode:t.value[5],line:"yr",dragShift:y,lineShift:y},{isNearly:m(a,y),lineNode:t.value[5],line:"yr",dragShift:y-(a-s||0),lineShift:y}]},S=[];Object.keys(b).forEach((e=>{b[e].forEach((t=>{t.isNearly&&(r.updateStyleByKey(e,t.dragShift),t.lineNode.style[e]=`${t.lineShift}px`,S.push(t.line))}))})),v(S,i,n)}))},v=(e,t,i)=>{i?e.includes("yr")?r.yr=!0:e.includes("yc")?r.yc=!0:e.includes("yl")&&(r.yl=!0):e.includes("yl")?r.yl=!0:e.includes("yc")?r.yc=!0:e.includes("yr")&&(r.yr=!0),t?e.includes("xb")?r.xb=!0:e.includes("xc")?r.xc=!0:e.includes("xt")&&(r.xt=!0):e.includes("xt")?r.xt=!0:e.includes("xc")?r.xc=!0:e.includes("xb")&&(r.xb=!0)},m=(e,t)=>Math.abs(e-t)<=o.value;return a((()=>{P.on("move",(({isDownward:e,isRightward:t})=>{h(e,t)})),P.on("unmove",(()=>{p()})),h(!1,!1)})),()=>l("div",{class:j},[i.map((e=>u(l("div",{key:e,ref:d,class:`${M} ${e.includes("x")?O:Y}`},null),[[c,r[e]]])))])}}),L="_boundBox_c2v03_1",X="_active_c2v03_8",B="_point_c2v03_13";const A=o({name:"BoundBox",props:{primitive:{type:Object,default:()=>{}},pStyle:{type:Object,default:()=>{}},index:{required:!0,type:Number,default:0}},emits:["closeContextmenu"],setup(e,{slots:t,emit:i}){const o=b(),{curPrimitive:s}=d(o),{curRef:a,cursors:u,angleToCursor:c,drawPoints:h}={curRef:n(null),cursors:n({}),angleToCursor:[{start:338,end:23,cursor:"nw"},{start:23,end:68,cursor:"n"},{start:68,end:113,cursor:"ne"},{start:113,end:158,cursor:"e"},{start:158,end:203,cursor:"se"},{start:203,end:248,cursor:"s"},{start:248,end:293,cursor:"sw"},{start:293,end:338,cursor:"w"}],drawPoints:{lt:0,t:45,rt:90,r:135,rb:180,b:225,lb:270,l:315}},v=t=>{const{width:i=0,height:n=0}=e.pStyle,o=t.includes("t"),r=t.includes("b"),l=t.includes("l"),s=t.includes("r");let a=l?0:i,c=o?0:n;return!o&&!r||l||s?o||r||!l&&!s||(a=l?0:i,c=Math.floor(n/2)):(a=i/2,c=o?0:n),{marginLeft:"-4px",marginTop:"-4px",left:`${a}px`,top:`${c}px`,cursor:u.value[t]}},m=()=>{const e={};let t=-1;for(const i in h){const n=(h[i]+360)%360;for(let o=0;o<c.length;o++){t=(t+1)%c.length;const o=c[t];if(n<23||n>=338){e[i]="nw-resize";break}if(o.start<=n&&n<o.end){e[i]=o.cursor+"-resize";break}}}return e},f=t=>{if(0!==t.button)return;t.stopPropagation(),t.preventDefault(),o.setClickPrimitiveStatus(!0),o.setCurPrimitive(e.primitive),u.value=m();const i=e.pStyle,n=t.clientY,r=t.clientX,l=i.top||0,s=i.left||0,a=t=>{const i=t.clientX,o=t.clientY,a={top:S.ceil(t.clientY-n+l),left:S.ceil(t.clientX-r+s)};e.primitive.updateStyle(a);const u=o-n>0,c=i-r>0;P.emit("move",{isDownward:u,isRightward:c})},c=()=>{P.emit("unmove"),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",c)};p((()=>{s.value&&(u.value=m())}));const y=e=>{e.stopPropagation(),e.preventDefault(),i("closeContextmenu")},g=r((()=>{var t;return(null==(t=s.value)?void 0:t.id)===e.primitive.id})),x=()=>Object.keys(h).map((t=>l("div",{key:t,class:B,style:v(t),onMousedown:i=>((t,i)=>{i.stopPropagation(),i.preventDefault();const{pStyle:n}=e,{height:o=0,width:r=0,top:l=0,left:s=0}=n,a=i.clientX,u=i.clientY,c=e=>{const i=e.clientX,c=e.clientY-u,d=i-a,p=/t/.test(t),h=/b/.test(t),v=/l/.test(t),m=/r/.test(t),f=o+(p?-c:h?c:0),y=r+(v?-d:m?d:0);Object.assign(n,{height:Math.max(f,0),width:Math.max(y,0),left:s+(v?d:0),top:l+(p?c:0)})},d=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",d)})(t,i)},null)));return()=>{var e;return l("div",{ref:a,class:[L,g.value&&X],onClick:y,onMousedown:f},[g.value?x():null,null==(e=t.default)?void 0:e.call(t)])}}}),G="_contextmenu_1ltzl_1",I=o({name:"ContextMenu",setup(e,{expose:t}){const i=w(),o=b(),a=_(),{curPrimitive:p}=d(o),{areaSelectVisible:v}=d(a),m=s({visible:n(!1),top:n(0),left:n(0),copyData:n(null)}),f=()=>{o.setClickPrimitiveStatus(!0)},y=()=>{if(!m.copyData)return void i.warning("请选择组件！");const e=m.copyData;e.style.top=m.top,e.style.left=m.left,o.addPrimitive(e)},g={"复制":()=>{const e=S.cloneDeep(p.value);e.id=h.createId(),m.copyData=e,i.success("复制成功！")},"粘贴":y,"删除":()=>{o.deleteCurPrimitive(),i.success("删除成功！")},"置顶":()=>{o.upCurComponent()},"置底":()=>{o.downCurComponent()},"上移":()=>{o.moveCurPrimitiveByIndex(1)},"下移":()=>{o.moveCurPrimitiveByIndex(-1)}},x={"组合":()=>{},"删除":()=>{}},C={"粘贴":y,"清空画布":()=>{o.clear()}},N=r((()=>p.value?g:v.value?x:C));return t({show:({top:e,left:t})=>{m.top=e,m.left=t,m.visible=!0},close:()=>{m.visible=!1}}),()=>u(l("div",{class:G,style:{top:`${m.top}px`,left:`${m.left}px`}},[l("ul",{onMouseup:f},[Object.entries(N.value).map((([e,t])=>l("li",{onClick:t},[e])))])]),[[c,m.visible]])}}),$=o({name:"Grid",render:()=>l("svg",{style:{position:"absolute",top:0,left:0},width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg"},[l("defs",null,[l("pattern",{id:"smallGrid",width:"7.236328125",height:"7.236328125",patternUnits:"userSpaceOnUse"},[l("path",{d:"M 7.236328125 0 L 0 0 0 7.236328125",fill:"none",stroke:"rgba(207, 207, 207, 0.3)","stroke-width":"1"},null)]),l("pattern",{id:"grid",width:"36.181640625",height:"36.181640625",patternUnits:"userSpaceOnUse"},[l("rect",{width:"36.181640625",height:"36.181640625",fill:"url(#smallGrid)"},null),l("path",{d:"M 36.181640625 0 L 0 0 0 36.181640625",fill:"none",stroke:"rgba(186, 186, 186, 0.5)","stroke-width":"1"},null)])]),l("rect",{width:"100%",height:"100%",fill:"url(#grid)"},null)])}),R="_editor_1iuos_1",U="_primitive_1iuos_8";const V=o({name:"Editor",components:{Grid:$,AreaSelect:N,ContextMenu:I},setup(){const e=b(),t=_(),{areaSelectVisible:i}=d(t),{groupState:o,onDrawGroupBoundry:r}=function(){const e=b(),t=_(),{primitives:i}=d(e),n=s({editorX:0,editorY:0,start:{x:0,y:0},width:0,height:0}),o=()=>{n.width=0,n.height=0,t.setAreaSelectVisible(!1),t.setAreaSelectOptions(null,[])},r=()=>{const e=l();if(e.length<=1)return void o();let i=1/0,r=1/0,s=-1/0,a=-1/0;e.forEach((e=>{var t;let o={};"Group"===e.cName?null==(t=e.childPrimitives)||t.forEach((e=>{const t=document.getElementById(`primitive${e.id}`).getBoundingClientRect();o.left=t.left-n.editorX,o.top=t.top-n.editorY,o.right=t.right-n.editorX,o.bottom=t.bottom-n.editorY,o.left<r&&(r=o.left),o.top<i&&(i=o.top),o.right>s&&(s=o.right),o.bottom>a&&(a=o.bottom)})):o=D(e.style),o.left<r&&(r=o.left),o.top<i&&(i=o.top),o.right>s&&(s=o.right),o.bottom>a&&(a=o.bottom)})),n.start.x=r,n.start.y=i,n.width=s-r,n.height=a-i;const u={left:r,top:i,width:n.width,height:n.height};t.setAreaSelectOptions(u,e)},l=()=>{const{x:e,y:t}=n.start;return i.value.filter((i=>{const{left:o,top:r,width:l,height:s}=D(i.style);if(e<=o&&t<=r&&o+l<=e+n.width&&r+s<=t+n.height)return i}))};return{groupState:n,onDrawGroupBoundry:e=>{o();const i=document.getElementById("editor").getBoundingClientRect();n.editorX=i.x,n.editorY=i.y;const l=e.clientX,s=e.clientY;n.start.x=l-n.editorX,n.start.y=s-n.editorY,t.setAreaSelectVisible(!0);const a=e=>{n.width=Math.abs(e.clientX-l),n.height=Math.abs(e.clientY-s),e.clientX<l&&(n.start.x=e.clientX-n.editorX),e.clientY<s&&(n.start.y=e.clientY-n.editorY)},u=e=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u),e.clientX!=l||e.clientY!=s?r():o()};document.addEventListener("mousemove",a),document.addEventListener("mouseup",u)}}}(),a=e.primitives,{curPrimitive:p}=d(e),h=n(null),g=n(null);v("AUXILIARY_LINE_KEY",g);const x=t=>{0===t.button&&(e.setClickPrimitiveStatus(!1),p||t.preventDefault(),r(t))},S=t=>{var i;e.isClickPrimitive||e.setCurPrimitive(null),2!==t.button&&(null==(i=h.value)||i.close())},w=e=>{var t;if(e.stopPropagation(),e.preventDefault(),!e.target)return;let i=e.target,n=e.offsetY,o=e.offsetX;for(;i instanceof SVGElement;)i=i.parentNode;for(;"editor"!==i.id;)o+=i.offsetLeft,n+=i.offsetTop,i=i.parentNode;null==(t=h.value)||t.show({top:n,left:o})},C=()=>{var e;null==(e=h.value)||e.close()},{getBoundBoxStyle:P}={getBoundBoxStyle:e=>{const t={};for(const[i,n]of Object.entries(e))n&&(t[i]=n+"px");return t},getPrimitiveStyle:e=>{const t={};for(const[i,n]of Object.entries(e))n&&(t[i]=n+"px");return t}},E=()=>a.map(((e,t)=>{let i;return l(A,{index:t,style:P(e.style),primitive:e,pStyle:e.style,onCloseContextmenu:C},"function"==typeof(n=i=m(f(e.cName),{id:`primitive${e.id}`,class:U,dataSource:e}))||"[object Object]"===Object.prototype.toString.call(n)&&!y(n)?i:{default:()=>[i]});var n}));return()=>l("div",{id:"editor",class:R,onMousedown:x,onMouseup:S,onContextmenu:w},[l($,null,null),u(l(N,{options:{start:o.start,width:o.width,height:o.height}},null),[[c,i]]),l(k,null,null),l(I,{ref:h},null),E()])}}),T="_container_79xjy_1",z=o({name:"Container",components:{Editor:V},setup(){const{...e}=(()=>{const e=b();return{handleDrop:t=>{t.preventDefault(),t.stopPropagation();const i=t.dataTransfer.getData("name"),n=document.querySelector("#editor").getBoundingClientRect(),o=new g[i],r={top:S.ceil(t.clientY-n.y),left:S.ceil(t.clientX-n.x)};o.updateStyle(r),e.addPrimitive(o)},handleDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},handleMouseDown:e=>{e.stopPropagation()},handleMouseUp:()=>{}}})();return{...e}},render(){return l(x,null,[l("div",{class:T,onDrop:this.handleDrop,onDragover:this.handleDragOver,onMousedown:this.handleMouseDown,onMouseup:this.handleMouseUp},[l(V,null,null)])])}});export{z as default};
//# sourceMappingURL=index-0825a268.js.map
